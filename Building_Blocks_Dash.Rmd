---
title: "Building Blocks"
output: 
  flexdashboard::flex_dashboard:
    logo: www/bb_logo.png
    theme:
      bg: "#ffffff"
      fg: "#1b7091" 
      primary: "#1b7091"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: column
runtime: shiny
---

```{r setup, include=FALSE}
library(dplyr)
library(DT)
library(flexdashboard)
library(ggplot2)
library(highcharter)
library(htmltools)
library(leaflet)
library(leafpop)
library(leaflet.providers)
library(shiny)
library(shinycssloaders)
library(shinyWidgets)
library(tibble)
library(tidyr)
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()
```

```{r global, include = F}
inventory <- readRDS("./data/inventory.rds")
counties <- readRDS("./in_counties.rds")
schools <- readRDS("./in_school_dist.rds")
providers <- readRDS("./sda_providers.rds")
```
# Overview

## Inputs {data-width=350 .sidebar}

## Map

### Indiana

# Inline 1

```{r overview-sidebar-inputs}

shinyApp(
	ui <- fillPage(
	padding = 10,
	fillRow(flex = c(1, 5),
		fillCol(
		inputPanel(
			h6("Choose Geography:"), 
			selectInput(
				inputId = "geo",
				label = NULL,
				choices = list(
					Districts = list(
						Counties = "counties",
						Schools = "schools",
						Providers = "providers"
					)
				),
				multiple = F
			),
			h6("Choose Variable:"),
			selectInput(
				inputId = "variable",
				label = NULL,
				choices = NULL,
				multiple = F
			)
		)
		),
		fillCol(
			leafletOutput("map", height = 600),
		)
	)
),
server = function(input, output) {
	df <- reactive({
		get(input$geo)
	})
	observeEvent(df(), {
		choices <- df() |> colnames() |> as.list() |> dput()
		updateSelectInput(inputId = "variable", choices = choices)
	})
	col <- reactive({
		df() |> 
			dplyr::select(input$variable)
	})
	output$head_df <- renderPrint({
		col()
	})
	output$map <- renderLeaflet({
		leaflet() |> 
			setView(-86.45713546504423, 38.56421435890006, zoom = 9) |>
			#base groups
			addProviderTiles("CartoDB.Positron")
	})
}
)
```

# Inline 2

```{r worldphones}
shinyApp(
  ui = fillPage(
    fillCol(flex = c(NA, 1), 
      inputPanel(
        selectInput("region", "Region:", choices = colnames(WorldPhones))
      ),
      plotOutput("phonePlot", height = "100%")
    )
  ),
  server = function(input, output) {
    output$phonePlot <- renderPlot({
      barplot(WorldPhones[,input$region]*1000, 
              ylab = "Number of Telephones", xlab = "Year")
    })
  },
  options = list(height = 600)
)
```

```{r main-map, eval = F, include = F}
#Read in
counties <- readRDS("./in_counties.rds")
schools <- readRDS("./in_school_dist.rds")
providers <- readRDS("./sda_providers.rds")
#color <- c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E")
factpal <- leaflet::colorFactor(topo.colors(5), providers$provider)
# map
leaflet() %>%
	setView(-86.45713546504423, 38.56421435890006, zoom = 9) |>
	#base groups
	addProviderTiles("CartoDB.Positron") |>
	#overlay groups
	addPolygons(
		data = counties,
		fillOpacity = .2,
		weight = 1,
		stroke = T,
		opacity = 1,
		popup =  ~name,
		color = "#808080",
		group = "Counties"
	) |>
	addPolygons(
		data = schools,
		popup = leafpop::popupTable(
			schools,
			zcol = c(4, 14:25),
			row.numbers = F
			),
		fillOpacity = .2,
		weight = 1,
		stroke = T,
		opacity = 1,
		color = "#1B9E77",
		group = "Schools"
		) |>
	addPolygons(
		data = providers,
		popup = leafpop::popupTable(
			providers,
			zcol = c(2, 3, 6:18),
			row.numbers = F
		),
		color = ~factpal(provider),
		group = "Providers"
	) |>
	#layer control
	addLayersControl(
		overlayGroups = c("Counties", "Schools", "Providers"),
		position = "topright",
		options = layersControlOptions(collapsed = FALSE)
	) |>
	# hide
	hideGroup(c("Counties", "Schools", "Providers"))

```






# leaflet map

```{r new-map}
shinyApp(
	ui = leafletOutput("plot1", height = 600), 
	server = function(input, output) {
	output$plot1 <- renderPlot({
		mtcars |> 
			ggplot() +
			aes(hp, mpg) + 
			geom_point()
	})
	}
)
```

# Schools

## chart {.tabset}

### Pre-K Enrollments

```{r pre-k-enrollments}
enrollments_pre_k <- readRDS("./enrollments_pre_k.rds")
highchartOutput("enrollments_pre_k")
output$enrollments_pre_k <- renderHighchart({
	highchart() |>
		hc_add_series(enrollments_pre_k,
			      name = "Vanderburgh",
			      "line",
			      hcaes(x = year,
			            y = vanderburgh)
		) |>
		hc_add_series(enrollments_pre_k,
			      name = "Warrick",
			      "line",
			      hcaes(x = year,
			            y = warrick)
		) |>
		hc_add_series(enrollments_pre_k,
			      name = "Posey",
			      "line",
			      hcaes(x = year,
			            y = posey)
		) |>
		hc_xAxis(type = 'datetime') |>
		hc_title(text = "Pre-K Enrollments") |>
		hc_subtitle(text = "2006-2022") |>
		hc_credits(text = "Indiana Department of Educ.",
			   enabled = T,
			   href = "https://www.in.gov/doe/it/data-center-and-reports/") |>
		hc_tooltip(table = T,
			   shared = T)
})
```


### Reading

```{r reading-scores, eval=F, include=F}
iread3_scores <- readRDS("./iread3_scores.rds")
highchartOutput("reading_scores")

output$reading_scores <- renderHighchart({
	hchart(
	iread3_scores,
	"bar",
	hcaes(x = race,
	      y = value,
	      group = corp_name)
) |>
	hc_xAxis(title = "") |> 
	hc_yAxis(title = "") |> 
	hc_title(text = "2021 Third Grade Reading Assessment") |>
	hc_subtitle(text = "2021") |>
	hc_credits(text = "Indiana Department of Education",
		   enabled = T,
		   href = "https://www.in.gov/doe/it/data-center-and-reports/") |>
	hc_caption(text = "School systems with few students in a demographic group may have the results suppressed to prevent identification of an individual student.")
})

```


# Data Warehouse

## Inputs {data-width=350 .sidebar}

At Building Blocks, we rely on timely, accurate data to benefit kids, parents, providers and community.  Much of the information is generated internally while some is created by others. Please confirm licensing terms with the owner prior to publishing the data.

```{r choose-dataset-dropdown, eval=F, include=F}
choices <- 
	list(
		"US" =
	     		list("US Poverty Estimates" = "us_saipe_est"),
		"Indiana" = 
			list(
			"First Steps Providers" = "first_steps_providers",
			"High School Graduation Rates" = "in_hs_grads",
			"IREAD-3 Results" = "iread_3_scores",
			"IN Pre-K Enrollments" = "in_pre_k"
			),
		"Building Blocks" =
			list(
			"Dataset 1" = "dataset1",
			"Dataset 2" = "dataset2"
			)
	
)
h6("Choose Dataset:")
selectInput(
	inputId = "dataset",
	label = NULL,
	choices = choices
)
h6("Metadata:")
#textOutput("mytext")
tableOutput("inventory_metadata")
metadata <- reactive({
	#get dataset
	dataset <-
		inventory |>
		filter(sheet == input$dataset) |>
		select(owner:licensed) |>
		mutate(across(everything(), ~as.character(.x)))
	#transpose
	names <- names(dataset)
	df.1 <- matrix(dataset, dimnames = list(names, "value"))
	df.2 <- data.frame(names = row.names(df.1), df.1)
	df.2
})

output$inventory_metadata <-renderTable({
	metadata()
})

```

## Outputs 

### Preview

```{r preview-dataset-ui, eval=F, include=F}
# create dataframe
data <- reactive({
    ss <- 'https://docs.google.com/spreadsheets/d/1KW7f-9_-4aKaPCp6gRGDaB0eeRIhWaqwcyr9vZh-1eU/edit?usp=sharing'
df <- googlesheets4::read_sheet(
	ss = ss,
	sheet = input$dataset
)
  })
# show dataset
dataTableOutput("preview")
```

```{r preview-dataset-server, eval=F, include=F}
output$preview <- renderDataTable({
    DT::datatable(data(),
    		rownames = F,
		extensions = 'Buttons',
		options = list(
		dom = 'Bfrtip',
		buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
		    ),
		class = "display"
		)
  })
```

